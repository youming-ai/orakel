# Orakel 项目开发路线图

> 基于深度代码审查和性能分析
> 目标：提升胜率、最大化利润、优化性能、改善用户体验
> 更新时间：2026-02-26

## 📊 当前状态分析

### 性能指标
| 指标 | 当前值 | 目标值 | 改进空间 |
|------|--------|--------|----------|
| **总体胜率** | 48.6% | 58-65% | +10-16% |
| **总PnL** | $156.60 (383笔) | $250-350 | +60-120% |
| **主循环耗时** | ~200ms/秒 | ~20ms/秒 | 10× |
| **网络请求** | ~20次/秒 | ~2-4次/秒 | 80-90% ↓ |

### 市场表现（回测数据）
| 市场 | 胜率 | 边缘乘数 | 状态 |
|------|------|----------|------|
| XRP | 54.2% | 1.0× | ✅ 最佳表现 |
| SOL | 51.0% | 1.0× | ✅ 良好 |
| ETH | 46.9% | 1.2× | ⚠️ 需改善 |
| BTC | 42.1% | 1.5× | ❌ 需优化 |

### 关键问题
1. **过度自信问题**：高边缘(≥20%)胜率仅43.6%，低边缘(<10%)胜率57.9%
2. **CHOP状态危险**：胜率38.9%，应避免交易
3. **性能瓶颈**：每秒重复计算，无缓存机制
4. **固定仓位**：未根据信号质量动态调整

---

## 🎯 分阶段开发计划

### Phase 1: 性能优化（1-2周）🔴 高优先级

> 目标：10×性能提升，为后续优化打基础

#### Sprint 1.1 - 增量计算系统（3天）

**任务清单：**
- [ ] **Task 1.1.1** - 实现`IncrementalRSI`类
  - 文件：`src/indicators/incremental.ts`
  - 功能：O(1)更新vs O(n)重算
  - 预期：RSI计算提速200×

- [ ] **Task 1.1.2** - 实现`RollingVolatilityCalculator`
  - 文件：`src/indicators/volatilityBuffer.ts`
  - 功能：环形缓冲区波动率计算
  - 预期：波动率计算提速150×

- [ ] **Task 1.1.3** - 实现`ObjectPool`类
  - 文件：`src/utils/objectPool.ts`
  - 功能：减少GC压力
  - 预期：内存分配减少10×

- [ ] **Task 1.1.4** - 集成到主循环
  - 文件：`src/index.ts`
  - 功能：替换现有计算函数
  - 测试：确保行为一致性

**验收标准：**
```bash
# 性能测试
bun run test:performance
# 预期：主循环 < 30ms/秒
# 功能测试
bun run test
# 预期：全部通过
```

#### Sprint 1.2 - 缓存层优化（2天）

**任务清单：**
- [ ] **Task 1.2.1** - 实现LRU缓存
  - 文件：`src/utils/lruCache.ts`
  - 功能：带大小限制的缓存

- [ ] **Task 1.2.2** - K线数据缓存（TTL 60s）
  - 文件：`src/data/binance.ts`
  - 预期：减少95%的K线请求

- [ ] **Task 1.2.3** - 订单簿缓存（TTL 3s）
  - 文件：`src/data/polymarket.ts`
  - 预期：减少70%的订单簿请求

- [ ] **Task 1.2.4** - 市场元数据缓存（TTL 30s）
  - 文件：`src/data/polymarket.ts`
  - 预期：减少95%的元数据请求

**验收标准：**
- 网络请求减少80%+
- 功能测试全部通过
- 缓存命中率 > 80%

#### Sprint 1.3 - 代码重构（2天）

**任务清单：**
- [ ] **Task 1.3.1** - 拆分`index.ts`
  - 目标：从1500行降至<400行
  - 提取：`src/pipeline/fetch.ts`, `src/pipeline/compute.ts`, `src/pipeline/persist.ts`

- [ ] **Task 1.3.2** - 提取终端渲染
  - 文件：`src/terminal.ts`

- [ ] **Task 1.3.3** - 合并重复代码
  - Tracker工厂函数
  - Config热重载修复

**验收标准：**
- `index.ts` < 400行
- `processMarket()` < 30行
- 所有测试通过

---

### Phase 2: 胜率提升（2-3周）🔴 高优先级

> 目标：胜率从48.6%提升至58-65%

#### Sprint 2.1 - 动态阈值系统（4天）

**任务清单：**
- [ ] **Task 2.1.1** - 实现`AdaptiveThresholdManager`
  - 文件：`src/engines/adaptiveThresholds.ts`
  - 功能：基于历史表现动态调整阈值
  - 预期：+5-8%胜率

- [ ] **Task 2.1.2** - 市场表现追踪器
  - 功能：追踪每市场最近20笔交易
  - 趋势检测：improving/stable/declining

- [ ] **Task 2.1.3** - 阶段感知阈值
  - EARLY阶段：降低20%阈值
  - MID阶段：标准阈值
  - LATE阶段：提高20%阈值

- [ ] **Task 2.1.4** - 集成到决策引擎
  - 文件：`src/engines/edge.ts`
  - 修改：`decide()`函数

**验收标准：**
- 回测胜率提升 > 5%
- 实盘观察期1周无异常

#### Sprint 2.2 - 信号质量模型（5天）

**任务清单：**
- [ ] **Task 2.2.1** - 实现`SignalQualityModel`
  - 文件：`src/engines/signalQuality.ts`
  - 功能：KNN预测胜率
  - 预期：+8-12%胜率

- [ ] **Task 2.2.2** - 特征相似度计算
  - 欧几里得距离
  - 加权平均（最近+最相似权重高）

- [ ] **Task 2.2.3** - 历史表现查询
  - 按市场/状态/阶段分组
  - 返回：count, winRate, avgEdge

- [ ] **Task 2.2.4** - 集成多模型系统
  - 文件：`src/engines/ensemble.ts`
  - 集成：波动率模型 + TA模型 + 订单簿模型

**验收标准：**
- 信号预测准确率 > 55%
- 回测胜率提升 > 8%

#### Sprint 2.3 - 增强状态检测（3天）

**任务清单：**
- [ ] **Task 2.3.1** - 实现`detectEnhancedRegime`
  - 文件：`src/engines/regime.ts`
  - 功能：状态置信度评分

- [ ] **Task 2.3.2** - 状态转移概率
  - 基于历史数据计算
  - 预测：下一状态概率

- [ ] **Task 2.3.3** - 状态置信度交易决策
  - 高置信度CHOP：跳过
  - 低置信度趋势：减少仓位

**验收标准：**
- CHOP状态识别准确率 > 80%
- CHOP状态交易减少 > 90%

#### Sprint 2.4 - 回测与调优（3天）

**任务清单：**
- [ ] **Task 2.4.1** - 完整回测系统
  - 文件：`src/backtest.ts`
  - 功能：测试所有新策略

- [ ] **Task 2.4.2** - A/B测试框架
  - 对比：旧策略 vs 新策略
  - 指标：胜率、PnL、夏普比率

- [ ] **Task 2.4.3** - 参数优化
  - 网格搜索最优参数
  - 交叉验证防止过拟合

**验收标准：**
- 回测胜率 > 55%
- 夏普比率 > 1.5
- 实盘验证期无回归

---

### Phase 3: 利润最大化（2-3周）🟡 中优先级

> 目标：PnL提升60-120%

#### Sprint 3.1 - 凯利公式仓位管理（4天）

**任务清单：**
- [ ] **Task 3.1.1** - 实现`calculateKellyPositionSize`
  - 文件：`src/engines/positionSizing.ts`
  - 功能：动态计算最优仓位
  - 预期：+30-50% PnL

- [ ] **Task 3.1.2** - 半凯利策略
  - 原因：减少波动和回撤
  - 实现：kelly × 0.5

- [ ] **Task 3.1.3** - 基于信心调整
  - 高信心(≥0.8)：增加20%
  - 低信心(<0.5)：减少50%

- [ ] **Task 3.1.4** - 集成到交易执行
  - 文件：`src/trader.ts`
  - 修改：`executeTrade()`

**验收标准：**
- 回测PnL提升 > 30%
- 最大回撤 < 15%

#### Sprint 3.2 - 费用优化（2天）

**任务清单：**
- [ ] **Task 3.2.1** - 实现`optimizePolymarketOrder`
  - 文件：`src/utils/fees.ts`
  - 功能：智能订单类型选择

- [ ] **Task 3.2.2** - Post-only策略
  - 条件：低紧迫性 + 时间充裕
  - 预期：获得Maker返利

- [ ] **Task 3.2.3** - 订单簿价格优化
  - 基于不平衡调整
  - 提高成交率

**验收标准：**
- 平均费用降低 > 20%
- 成交率保持 > 90%

#### Sprint 3.3 - 动态止损/止盈（3天）

**任务清单：**
- [ ] **Task 3.3.1** - 实现`calculateDynamicStops`
  - 文件：`src/engines/riskManagement.ts`
  - 功能：基于波动率的动态止损

- [ ] **Task 3.3.2** - 实现`TrailingStopManager`
  - 功能：移动止损
  - 条件：高信心(>0.75)

- [ ] **Task 3.3.3** - 时间衰减止盈
  - 时间充裕 + 高信心：2.0倍盈亏比
  - 时间紧迫：1.2倍盈亏比

**验收标准：**
- 回测PnL提升 > 15%
- 最大单笔亏损 < 5%

#### Sprint 3.4 - 套利检测（2天）

**任务清单：**
- [ ] **Task 3.4.1** - 实现`detectArbitrage`
  - 文件：`src/engines/arbitrage.ts`
  - 类型：跨市场、价格分歧、时机

- [ ] **Task 3.4.2** - 纯套利检测
  - 条件：sum < 0.98
  - 动作：自动执行

- [ ] **Task 3.4.3** - Binance vs Polymarket分歧
  - 条件：分歧 > 10%
  - 预期：+10-20% PnL

**验收标准：**
- 套利捕捉率 > 80%
- 套利平均PnL > 2%

---

### Phase 4: UI/UX优化（1-2周）🟢 低优先级

> 目标：显著改善用户体验

#### Sprint 4.1 - 实时可视化（3天）

**任务清单：**
- [ ] **Task 4.1.1** - 实时价格图表
  - 文件：`web/src/components/PriceChart.tsx`
  - 库：lightweight-charts
  - 功能：K线 + VWAP线

- [ ] **Task 4.1.2** - 信号强度仪表板
  - 文件：`web/src/components/SignalStrength.tsx`
  - 功能：边缘、信心、概率、波动率可视化

- [ ] **Task 4.1.3** - 交易热力图
  - 文件：`web/src/components/TradingHeatmap.tsx`
  - 功能：按小时显示胜率/PnL

**验收标准：**
- 图表更新延迟 < 500ms
- 移动端适配良好

#### Sprint 4.2 - 告警系统（2天）

**任务清单：**
- [ ] **Task 4.2.1** - 实现`AlertSystem`
  - 文件：`web/src/components/AlertSystem.tsx`
  - 功能：多类别告警

- [ ] **Task 4.2.2** - 告警配置UI
  - 可配置：高价值交易、套利机会、状态变化
  - 浏览器通知集成

- [ ] **Task 4.2.3** - 告警历史
  - 功能：最近50条告警
  - 时间线展示

**验收标准：**
- 告警延迟 < 1s
- 告警准确率 > 90%

#### Sprint 4.3 - 性能与可访问性（2天）

**任务清单：**
- [ ] **Task 4.3.1** - WebSocket优化
  - 使用`useDashboardStateWithWs()`
  - 减少冗余轮询

- [ ] **Task 4.3.2** - ARIA属性
  - 所有按钮添加`aria-label`
  - 展开区域添加`aria-expanded`

- [ ] **Task 4.3.3** - Loading状态
  - 所有mutations添加pending状态
  - 禁用重复点击

**验收标准：**
- Lighthouse可访问性分数 > 90
- WebSocket连接时无轮询

---

## 📈 成功指标

### 核心指标
| 指标 | 当前 | Phase 2目标 | Phase 3目标 |
|------|------|-------------|-------------|
| 胜率 | 48.6% | 58% | 60% |
| PnL/笔 | $0.41 | $0.60 | $0.80 |
| 夏普比率 | ~1.0 | 1.5 | 2.0 |
| 最大回撤 | - | - | <15% |

### 性能指标
| 指标 | 当前 | Phase 1目标 |
|------|------|-------------|
| 主循环耗时 | 200ms | 20ms |
| 网络请求/秒 | ~20 | 2-4 |
| 内存使用/小时 | 50MB | 5MB |

### 用户体验指标
| 指标 | 当前 | Phase 4目标 |
|------|------|-------------|
| 页面加载 | - | <2s |
| 图表更新延迟 | - | <500ms |
| Lighthouse分数 | - | >90 |

---

## 🗓️ 时间估算

| Phase | 内容 | 预估时间 | 优先级 |
|-------|------|----------|--------|
| Phase 1 | 性能优化 | 1-2周 | 🔴 高 |
| Phase 2 | 胜率提升 | 2-3周 | 🔴 高 |
| Phase 3 | 利润最大化 | 2-3周 | 🟡 中 |
| Phase 4 | UI/UX优化 | 1-2周 | 🟢 低 |
| **总计** | | **6-10周** | |

---

## ⚠️ 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 过度拟合 | 高 | 中 | 交叉验证 + 实盘验证 |
| 性能回归 | 中 | 低 | 完整测试覆盖 |
| 市场变化 | 高 | 高 | 持续监控 + 动态调整 |
| 技术债务 | 中 | 中 | 代码审查 + 重构 |

---

## 📋 检查清单

### 每个Sprint结束
- [ ] `bun run lint` 通过
- [ ] `bun run typecheck` 通过
- [ ] `bun run test` 全部通过
- [ ] 回测验证无回归
- [ ] 文档更新

### 每个Phase结束
- [ ] 完整回测报告
- [ ] 性能profiling
- [ ] 代码审查
- [ ] 部署到测试环境
- [ ] 实盘验证期（1-2周）

---

## 🔗 相关文档

- [深度审查报告](./DEEP_REVIEW.md) - 详细的技术分析
- [当前开发计划](./DEVELOPMENT_PLAN.md) - 现有的开发任务
- [系统架构](./architecture.md) - 架构文档
- [交易策略](./trading-strategy.md) - 策略说明
